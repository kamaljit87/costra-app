AWSTemplateFormatVersion: '2010-09-09'
Description: 'Costra AWS Billing Connection - Grants Costra read-only access to AWS billing and cost data with CUR support'

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: Connection Information
      Parameters:
      - ConnectionName
      - CostraAccountId
    - Label:
        default: Security
      Parameters:
      - ExternalId
    - Label:
        default: Callback (Auto-filled)
      Parameters:
      - CallbackUrl
    ParameterLabels:
      ConnectionName:
        default: 'Connection Name (descriptive alias for this AWS account)'
      CostraAccountId:
        default: 'Costra AWS Account ID'
      ExternalId:
        default: 'External ID (for secure cross-account access)'
      CallbackUrl:
        default: 'Costra Callback URL (do not modify)'

Parameters:
  ConnectionName:
    Type: String
    Description: 'Descriptive name for this connection (used to identify your account in Costra)'
    Default: 'costra-billing-connection'
    AllowedPattern: '^[a-z0-9-]+$'
    ConstraintDescription: 'Must be lowercase alphanumeric with hyphens only (3-39 characters). Kept short to fit S3 bucket naming limits.'
    MinLength: 3
    MaxLength: 39

  CostraAccountId:
    Type: String
    Description: 'Costra AWS Account ID (provided by Costra)'
    AllowedPattern: '^[0-9]{12}$'
    ConstraintDescription: 'Must be a valid 12-digit AWS account ID'

  ExternalId:
    Type: String
    Description: 'External ID for secure cross-account access (provided by Costra)'
    MinLength: 16
    MaxLength: 1224
    NoEcho: true
    AllowedPattern: '^[a-zA-Z0-9+/=._-]+$'
    ConstraintDescription: 'External ID must contain only alphanumeric characters and safe special characters'

  CallbackUrl:
    Type: String
    Description: 'Costra API callback URL (auto-filled, do not modify)'
    Default: ''

Conditions:
  HasCallbackUrl: !Not [!Equals [!Ref CallbackUrl, '']]

Resources:
  CostraAccessRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'CostraAccessRole-${ConnectionName}'
      Description: !Sub 'Role for Costra to access AWS billing and cost data for ${ConnectionName}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowCostraAssumeRole
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${CostraAccountId}:root'
            Action: 'sts:AssumeRole'
            Condition:
              StringEquals:
                'sts:ExternalId': !Ref ExternalId
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/job-function/Billing
      Policies:
        - PolicyName: CostraCostExplorerAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: CostExplorerAccess
                Effect: Allow
                Action:
                  - 'ce:GetCostAndUsage'
                  - 'ce:GetCostAndUsageWithResources'
                  - 'ce:GetDimensionValues'
                  - 'ce:GetReservationCoverage'
                  - 'ce:GetReservationPurchaseRecommendation'
                  - 'ce:GetReservationUtilization'
                  - 'ce:GetRightsizingRecommendation'
                  - 'ce:GetSavingsPlansCoverage'
                  - 'ce:GetSavingsPlansPurchaseRecommendation'
                  - 'ce:GetSavingsPlansPurchaseRecommendationDetails'
                  - 'ce:GetSavingsPlansUtilization'
                  - 'ce:GetSavingsPlansUtilizationDetails'
                  - 'ce:GetUsageReport'
                  - 'ce:ListCostCategoryDefinitions'
                  - 'ce:DescribeCostCategoryDefinition'
                  - 'ce:GetCostForecast'
                  - 'ce:GetAnomalies'
                  - 'ce:GetAnomalyMonitors'
                  - 'ce:GetAnomalySubscriptions'
                Resource: '*'
              - Sid: CostAndUsageReportsAccess
                Effect: Allow
                Action:
                  - 'cur:DescribeReportDefinitions'
                  - 'cur:PutReportDefinition'
                  - 'cur:ModifyReportDefinition'
                  - 'cur:DeleteReportDefinition'
                Resource: '*'
              - Sid: BCMDataExportsAccess
                Effect: Allow
                Action:
                  - 'bcm-data-exports:ListTables'
                  - 'bcm-data-exports:CreateExport'
                  - 'bcm-data-exports:GetExport'
                  - 'bcm-data-exports:ListExports'
                  - 'bcm-data-exports:UpdateExport'
                  - 'bcm-data-exports:DeleteExport'
                Resource: '*'
        - PolicyName: CostraCURBucketAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: CURBucketManage
                Effect: Allow
                Action:
                  - 's3:CreateBucket'
                  - 's3:PutBucketPolicy'
                  - 's3:PutBucketTagging'
                  - 's3:PutEncryptionConfiguration'
                  - 's3:PutLifecycleConfiguration'
                  - 's3:PutBucketPublicAccessBlock'
                  - 's3:GetBucketLocation'
                  - 's3:GetBucketPolicy'
                Resource:
                  - !Sub 'arn:aws:s3:::costra-cur-${AWS::AccountId}-${ConnectionName}'
              - Sid: CURBucketReadWrite
                Effect: Allow
                Action:
                  - 's3:GetObject'
                  - 's3:ListBucket'
                  - 's3:GetBucketLocation'
                  - 's3:DeleteObject'
                Resource:
                  - !Sub 'arn:aws:s3:::costra-cur-${AWS::AccountId}-${ConnectionName}'
                  - !Sub 'arn:aws:s3:::costra-cur-${AWS::AccountId}-${ConnectionName}/*'
        - PolicyName: CostraStackSelfCleanup
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: CloudFormationSelfDelete
                Effect: Allow
                Action:
                  - 'cloudformation:DeleteStack'
                  - 'cloudformation:DescribeStacks'
                Resource: !Sub 'arn:aws:cloudformation:*:${AWS::AccountId}:stack/${ConnectionName}/*'
              - Sid: IAMRoleSelfDelete
                Effect: Allow
                Action:
                  - 'iam:DeleteRole'
                  - 'iam:DeleteRolePolicy'
                  - 'iam:DetachRolePolicy'
                  - 'iam:ListRolePolicies'
                  - 'iam:ListAttachedRolePolicies'
                Resource: !Sub 'arn:aws:iam::${AWS::AccountId}:role/CostraAccessRole-${ConnectionName}'
        - PolicyName: CostraOrganizationsAndMonitoring
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: OrganizationsAccess
                Effect: Allow
                Action:
                  - 'organizations:DescribeOrganization'
                  - 'organizations:DescribeAccount'
                  - 'organizations:DescribeOrganizationalUnit'
                  - 'organizations:ListAccounts'
                  - 'organizations:ListOrganizationalUnitsForParent'
                  - 'organizations:ListParents'
                  - 'organizations:ListRoots'
                  - 'organizations:ListTagsForResource'
                Resource: '*'
              - Sid: CloudWatchMetricsAccess
                Effect: Allow
                Action:
                  - 'cloudwatch:GetMetricData'
                  - 'cloudwatch:ListMetrics'
                  - 'cloudwatch:GetMetricStatistics'
                Resource: '*'
              - Sid: TaggingAccess
                Effect: Allow
                Action:
                  - 'tag:GetResources'
                  - 'tag:GetTagKeys'
                  - 'tag:GetTagValues'
                Resource: '*'
      MaxSessionDuration: 3600
      Tags:
        - Key: ManagedBy
          Value: Costra
        - Key: Purpose
          Value: BillingDataAccess
        - Key: ConnectionName
          Value: !Ref ConnectionName
        - Key: CreatedBy
          Value: CloudFormation
        - Key: CostraAccountId
          Value: !Ref CostraAccountId

  # S3 bucket for CUR 2.0 Data Exports (must exist for BCM to deliver; policy applied by Costra on verify/setup)
  CostraCURBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Sub 'costra-cur-${AWS::AccountId}-${ConnectionName}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LifecycleConfiguration:
        Rules:
          - Id: ExpireOldReports
            Status: Enabled
            ExpirationInDays: 400
            Filter: {}
      Tags:
        - Key: ManagedBy
          Value: Costra
        - Key: Purpose
          Value: CostAndUsageReports
        - Key: ConnectionName
          Value: !Ref ConnectionName

  # Lambda function that notifies Costra API when the stack is created
  CostraCallbackRole:
    Type: AWS::IAM::Role
    Condition: HasCallbackUrl
    Properties:
      RoleName: !Sub 'CostraCallbackRole-${ConnectionName}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Tags:
        - Key: ManagedBy
          Value: Costra

  CostraCallbackFunction:
    Type: AWS::Lambda::Function
    Condition: HasCallbackUrl
    Properties:
      FunctionName: !Sub 'costra-callback-${ConnectionName}'
      Runtime: python3.12
      Handler: index.handler
      Timeout: 30
      MemorySize: 128
      Role: !GetAtt CostraCallbackRole.Arn
      Tags:
        - Key: ManagedBy
          Value: Costra
      Code:
        ZipFile: |
          import json
          import urllib.request
          import urllib.error

          def send_cfn_response(event, context, status, reason=""):
              body = json.dumps({
                  "Status": status,
                  "Reason": reason or f"See CloudWatch Log Stream: {context.log_stream_name}",
                  "PhysicalResourceId": context.log_stream_name,
                  "StackId": event["StackId"],
                  "RequestId": event["RequestId"],
                  "LogicalResourceId": event["LogicalResourceId"],
              }).encode("utf-8")
              req = urllib.request.Request(
                  event["ResponseURL"],
                  data=body,
                  headers={"Content-Type": ""},
                  method="PUT",
              )
              urllib.request.urlopen(req)

          def handler(event, context):
              print(json.dumps({"RequestType": event["RequestType"], "Props": event.get("ResourceProperties", {})}))
              # Only notify on Create (not Update/Delete)
              if event["RequestType"] != "Create":
                  send_cfn_response(event, context, "SUCCESS", "Skipped (not a Create)")
                  return

              props = event["ResourceProperties"]
              callback_url = props.get("CallbackUrl", "")
              if not callback_url:
                  send_cfn_response(event, context, "SUCCESS", "No callback URL")
                  return

              payload = json.dumps({
                  "accountId": props.get("AccountId", ""),
                  "externalId": props.get("ExternalId", ""),
                  "roleArn": props.get("RoleArn", ""),
                  "connectionName": props.get("ConnectionName", ""),
                  "region": props.get("Region", "us-east-1"),
                  "stackName": props.get("StackName", ""),
              }).encode("utf-8")

              try:
                  req = urllib.request.Request(
                      callback_url,
                      data=payload,
                      headers={"Content-Type": "application/json"},
                      method="POST",
                  )
                  resp = urllib.request.urlopen(req, timeout=25)
                  result = resp.read().decode("utf-8")
                  print(f"Callback success: {resp.status} {result}")
              except urllib.error.HTTPError as e:
                  print(f"Callback HTTP error: {e.code} {e.read().decode('utf-8', errors='replace')}")
              except Exception as e:
                  print(f"Callback error: {e}")
              # Always succeed â€” callback failure should not roll back the stack
              send_cfn_response(event, context, "SUCCESS", "Callback sent")

  NotifyCostra:
    Type: Custom::CostraCallback
    Condition: HasCallbackUrl
    DependsOn: CostraAccessRole
    Properties:
      ServiceToken: !GetAtt CostraCallbackFunction.Arn
      CallbackUrl: !Ref CallbackUrl
      AccountId: !Ref AWS::AccountId
      ExternalId: !Ref ExternalId
      RoleArn: !GetAtt CostraAccessRole.Arn
      ConnectionName: !Ref ConnectionName
      Region: !Ref AWS::Region
      StackName: !Ref AWS::StackName

Outputs:
  RoleArn:
    Description: 'ARN of the IAM role that Costra will use to access your AWS account'
    Value: !GetAtt CostraAccessRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-RoleArn'

  ConnectionName:
    Description: 'Name of this connection'
    Value: !Ref ConnectionName
    Export:
      Name: !Sub '${AWS::StackName}-ConnectionName'

  AccountId:
    Description: 'AWS Account ID where this stack is deployed'
    Value: !Ref AWS::AccountId
    Export:
      Name: !Sub '${AWS::StackName}-AccountId'

  StackName:
    Description: 'CloudFormation stack name'
    Value: !Ref AWS::StackName
    Export:
      Name: !Sub '${AWS::StackName}-StackName'

  Region:
    Description: 'AWS Region where this stack is deployed'
    Value: !Ref AWS::Region
    Export:
      Name: !Sub '${AWS::StackName}-Region'

  CURBucketName:
    Description: 'S3 bucket for CUR 2.0 Data Exports (bucket policy applied by Costra when you verify or run Set up CUR)'
    Value: !Ref CostraCURBucket
    Export:
      Name: !Sub '${AWS::StackName}-CURBucket'
